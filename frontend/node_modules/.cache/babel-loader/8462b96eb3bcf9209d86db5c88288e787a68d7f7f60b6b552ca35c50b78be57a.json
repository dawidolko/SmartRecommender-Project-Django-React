{"ast":null,"code":"/**\n * ClientDashboard Component\n *\n * Authors: Dawid Olko & Piotr Smoła\n * Date: 2025-11-02\n * Version: 2.0\n *\n * Client panel dashboard displaying personalized analytics, statistics,\n * and product recommendations based on user's purchase history.\n *\n * Features:\n *   - Purchase statistics (total items, complaints, orders this month)\n *   - Average order value calculation\n *   - Order trends line chart (monthly spending)\n *   - Category distribution pie chart (spending by category)\n *   - Personalized product recommendations (3 algorithms)\n *   - Algorithm selection preview:\n *     * Collaborative Filtering - Based on similar users\n *     * Content-Based Filtering - Based on product attributes\n *     * Fuzzy Logic - Based on fuzzy user profile\n *   - Animated counters (CountUp effect)\n *   - Responsive chart sizing\n *   - Product quick view and navigation\n *\n * Dashboard Metrics:\n *   1. Purchased Items Count - Total products bought by user\n *   2. Complaints Count - Total complaints filed\n *   3. Orders This Month - Number of orders in current month\n *   4. Average Order Value - Mean spending per order\n *\n * Charts:\n *   1. Order Trends (Line Chart):\n *      - X-axis: Months (formatted as \"MMM yyyy\")\n *      - Y-axis: Total spending (PLN)\n *      - Shows spending patterns over time\n *\n *   2. Category Distribution (Pie Chart):\n *      - Shows percentage of spending per category\n *      - Helps users understand their purchase preferences\n *      - Color-coded segments\n *\n * Recommendations:\n *   - Fetches user's active algorithm preference\n *   - Displays top 6 recommended products\n *   - Shows algorithm name in title\n *   - Clicking product navigates to detail page\n *\n * State Management:\n *   - purchasedItems: Total items purchased\n *   - complaints: Complaint count\n *   - orderSummary: {ordersThisMonth, avgOrderValue}\n *   - orderTrendsData: Chart.js data for line chart\n *   - categoryDistributionData: Chart.js data for pie chart\n *   - recommendedProducts: Array of product recommendations\n *   - currentAlgorithm: Active recommendation algorithm\n *   - loading: Loading state for async operations\n *   - error: Error message if API fails\n *\n * API Endpoints:\n *   - GET /api/orders/ - Fetch user's orders\n *   - GET /api/client-stats/ - Fetch dashboard statistics\n *   - GET /api/recommendation-settings/ - Get user's algorithm preference\n *   - GET /api/recommendation-preview/?algorithm={alg} - Get recommendations\n *\n * Calculations:\n *   - Average Order Value = Σ(order totals) / count(orders)\n *   - Category Spending = Σ(product prices) grouped by category\n *   - Monthly Trends = Σ(order values) grouped by month\n *\n * @component\n * @returns {React.ReactElement} Client dashboard with analytics and recommendations\n *//* eslint-disable react-hooks/exhaustive-deps */import React,{useEffect,useState,useRef}from\"react\";import axios from\"axios\";import CountUp from\"react-countup\";import{Line,Pie}from\"react-chartjs-2\";import\"chart.js/auto\";import{format}from\"date-fns\";import{useNavigate}from\"react-router-dom\";import\"./ClientDashboard.scss\";import config from\"../../config/config\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const ClientDashboard=()=>{const[purchasedItems,setPurchasedItems]=useState(0);const[complaints,setComplaints]=useState(0);const[orderSummary,setOrderSummary]=useState({ordersThisMonth:0,avgOrderValue:0});const[orderTrendsData,setOrderTrendsData]=useState(null);const[categoryDistributionData,setCategoryDistributionData]=useState(null);const[chartOptions,setChartOptions]=useState(null);const[recommendedProducts,setRecommendedProducts]=useState([]);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[,setCurrentAlgorithm]=useState(\"collaborative\");const[recommendationTitle,setRecommendationTitle]=useState(\"Recommended For You (Collaborative Filtering)\");const dataFetchedRef=useRef(false);const navigate=useNavigate();const baseOptions={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:\"top\"}}};useEffect(()=>{if(dataFetchedRef.current)return;dataFetchedRef.current=true;const token=localStorage.getItem(\"access\");const ordersRequest=axios.get(`${config.apiUrl}/api/orders/`,{headers:{Authorization:`Bearer ${token}`}});const clientStatsRequest=axios.get(`${config.apiUrl}/api/client-stats/`,{headers:{Authorization:`Bearer ${token}`}});const algorithmRequest=axios.get(`${config.apiUrl}/api/recommendation-settings/`,{headers:{Authorization:`Bearer ${token}`}});const fetchingAlgorithm=algorithmRequest.then(response=>{const algorithm=response.data.active_algorithm||\"collaborative\";setCurrentAlgorithm(algorithm);if(algorithm===\"collaborative\"){setRecommendationTitle(\"Recommended For You (Collaborative Filtering)\");}else if(algorithm===\"content_based\"){setRecommendationTitle(\"Recommended For You (Content-Based)\");}else if(algorithm===\"fuzzy_logic\"){setRecommendationTitle(\"Recommended For You (Fuzzy Logic)\");}else{setRecommendationTitle(\"Recommended For You\");}return axios.get(`${config.apiUrl}/api/recommendation-preview/?algorithm=${algorithm}`,{headers:{Authorization:`Bearer ${token}`}});}).catch(error=>{console.error(\"Error fetching algorithm:\",error);setCurrentAlgorithm(\"collaborative\");setRecommendationTitle(\"Recommended For You (Collaborative Filtering)\");return axios.get(`${config.apiUrl}/api/recommendation-preview/?algorithm=collaborative`,{headers:{Authorization:`Bearer ${token}`}});});Promise.all([ordersRequest,clientStatsRequest,fetchingAlgorithm]).then(async _ref=>{let[ordersRes,clientStatsRes,recommendedProductsRes]=_ref;const orders=ordersRes.data;const trendsMap={};orders.forEach(order=>{const monthLabel=format(new Date(order.date_order),\"MMM yyyy\");trendsMap[monthLabel]=(trendsMap[monthLabel]||0)+1;});const trendArray=Object.entries(trendsMap);trendArray.sort((_ref2,_ref3)=>{let[labelA]=_ref2;let[labelB]=_ref3;const dateA=new Date(labelA);const dateB=new Date(labelB);return dateA-dateB;});const sortedLabels=trendArray.map(_ref4=>{let[label]=_ref4;return label;});const sortedData=trendArray.map(_ref5=>{let[,count]=_ref5;return count;});const maxTrend=Math.max(...sortedData,0);const dynamicMax=maxTrend+2;const orderTrends={labels:sortedLabels,datasets:[{label:\"Orders\",data:sortedData,fill:false,borderColor:\"rgba(75,192,192,1)\"}]};setOrderTrendsData(orderTrends);const dynamicOptions={...baseOptions,scales:{y:{min:0,max:dynamicMax,ticks:{stepSize:1,precision:0}}}};setChartOptions(dynamicOptions);const currentMonth=format(new Date(),\"MMM yyyy\");const ordersThisMonth=orders.filter(order=>format(new Date(order.date_order),\"MMM yyyy\")===currentMonth).length;const totalValue=orders.reduce((sum,order)=>sum+(order.total||0),0);const avgOrderValue=orders.length>0?totalValue/orders.length:0;setOrderSummary({ordersThisMonth,avgOrderValue});const stats=clientStatsRes.data;setPurchasedItems(stats.purchased_items);setComplaints(stats.complaints);const catDist=stats.category_distribution;const catChart={labels:catDist.labels,datasets:[{data:catDist.data,backgroundColor:[\"#007bff\",\"#28a745\",\"#ffc107\",\"#dc3545\",\"#6f42c1\",\"#17a2b8\"]}]};setCategoryDistributionData(catChart);let products=[];if(recommendedProductsRes.data&&recommendedProductsRes.data.length>0){products=recommendedProductsRes.data.slice(0,4);}if(products.length===0){try{const fallbackResponse=await axios.get(`${config.apiUrl}/api/recommended-products/`,{headers:{Authorization:`Bearer ${token}`}});products=fallbackResponse.data.slice(0,4);}catch(err){console.error(\"Error fetching fallback recommendations:\",err);}}setRecommendedProducts(products);setLoading(false);}).catch(err=>{console.error(\"Error fetching data:\",err);setError(\"Failed to fetch data. Please try again.\");setLoading(false);localStorage.removeItem(\"access\");navigate(\"/\");window.location.reload();});},[]);useEffect(()=>{const handleStorageChange=e=>{if(e.key===\"recommendationAlgorithm\"){setCurrentAlgorithm(e.newValue||\"collaborative\");fetchRecommendedProducts(e.newValue||\"collaborative\");}};const handleCustomEvent=e=>{if(e.detail&&e.detail.algorithm){setCurrentAlgorithm(e.detail.algorithm);fetchRecommendedProducts(e.detail.algorithm);}};window.addEventListener(\"storage\",handleStorageChange);window.addEventListener(\"algorithmChanged\",handleCustomEvent);return()=>{window.removeEventListener(\"storage\",handleStorageChange);window.removeEventListener(\"algorithmChanged\",handleCustomEvent);};},[]);const fetchRecommendedProducts=async algorithm=>{const token=localStorage.getItem(\"access\");if(!token)return;try{const response=await axios.get(`${config.apiUrl}/api/recommendation-preview/?algorithm=${algorithm}`,{headers:{Authorization:`Bearer ${token}`}});let products=[];if(response.data&&response.data.length>0){products=response.data.slice(0,4);}if(products.length===0){try{const fallbackResponse=await axios.get(`${config.apiUrl}/api/recommended-products/`,{headers:{Authorization:`Bearer ${token}`}});products=fallbackResponse.data.slice(0,4);}catch(err){console.error(\"Error fetching fallback recommendations:\",err);}}setRecommendedProducts(products);if(algorithm===\"collaborative\"){setRecommendationTitle(\"Recommended For You (Collaborative Filtering)\");}else if(algorithm===\"content_based\"){setRecommendationTitle(\"Recommended For You (Content-Based)\");}else if(algorithm===\"fuzzy_logic\"){setRecommendationTitle(\"Recommended For You (Fuzzy Logic)\");}else{setRecommendationTitle(\"Recommended For You\");}}catch(err){console.error(\"Error fetching recommended products:\",err);try{const fallbackResponse=await axios.get(`${config.apiUrl}/api/recommended-products/`,{headers:{Authorization:`Bearer ${token}`}});setRecommendedProducts(fallbackResponse.data.slice(0,4));}catch(fallbackErr){console.error(\"Error fetching fallback recommendations:\",fallbackErr);setRecommendedProducts([]);}setRecommendationTitle(\"Recommended For You\");}};if(loading){return/*#__PURE__*/_jsx(\"div\",{className:\"loading-spinner\"});}if(error){return/*#__PURE__*/_jsx(\"div\",{style:{padding:\"2rem\",color:\"red\"},children:error});}const handleProductClick=productId=>{navigate(`/product/${productId}`);};return/*#__PURE__*/_jsxs(\"div\",{className:\"container client-dashboard\",children:[/*#__PURE__*/_jsx(\"h1\",{children:\"Client Dashboard\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"row mt-4\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"col-md-6 margin-bottom-4\",children:/*#__PURE__*/_jsx(\"div\",{className:\"small-box bg-primary\",style:{cursor:\"pointer\"},onClick:()=>navigate(\"/client/orders\"),children:/*#__PURE__*/_jsxs(\"div\",{className:\"inner\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"font-size-4\",children:/*#__PURE__*/_jsx(CountUp,{end:purchasedItems,duration:1.5})}),/*#__PURE__*/_jsx(\"p\",{className:\"summary-title\",children:\"Purchased Items\"})]})})}),/*#__PURE__*/_jsx(\"div\",{className:\"col-md-6 margin-bottom-4\",children:/*#__PURE__*/_jsx(\"div\",{className:\"small-box bg-danger\",style:{cursor:\"pointer\"},onClick:()=>navigate(\"/client/complaints\"),children:/*#__PURE__*/_jsxs(\"div\",{className:\"inner\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"font-size-4\",children:/*#__PURE__*/_jsx(CountUp,{end:complaints,duration:1.5})}),/*#__PURE__*/_jsx(\"p\",{className:\"summary-title\",children:\"Complaints\"})]})})}),/*#__PURE__*/_jsx(\"div\",{className:\"col-md-6 margin-bottom-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"small-box bg-success\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"font-size-4\",children:/*#__PURE__*/_jsx(CountUp,{end:orderSummary.ordersThisMonth,duration:1.5})}),/*#__PURE__*/_jsx(\"p\",{className:\"summary-title\",children:\"Orders This Month\"})]})}),/*#__PURE__*/_jsx(\"div\",{className:\"col-md-6 margin-bottom-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"small-box bg-info\",children:[/*#__PURE__*/_jsxs(\"h3\",{className:\"font-size-4\",children:[\"$\",orderSummary.avgOrderValue.toFixed(2)]}),/*#__PURE__*/_jsx(\"p\",{className:\"summary-title\",children:\"Average Order Value\"})]})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"dashboard-charts my-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"order-trends-chart\",children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Order Trends\"}),/*#__PURE__*/_jsx(\"div\",{className:\"chart-container\",children:orderTrendsData&&chartOptions?/*#__PURE__*/_jsx(Line,{data:orderTrendsData,options:chartOptions}):/*#__PURE__*/_jsx(\"p\",{children:\"No order trends data available.\"})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"category-distribution-chart\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"mt-4\",children:\"Category Distribution\"}),/*#__PURE__*/_jsx(\"div\",{className:\"chart-container\",children:categoryDistributionData?/*#__PURE__*/_jsx(Pie,{data:categoryDistributionData,options:baseOptions}):/*#__PURE__*/_jsx(\"p\",{children:\"No category distribution data available.\"})})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"dashboard-recommendations my-4\",children:[/*#__PURE__*/_jsx(\"h2\",{children:recommendationTitle}),/*#__PURE__*/_jsx(\"div\",{className:\"recommendations-grid\",children:recommendedProducts&&recommendedProducts.length>0?recommendedProducts.map((product,index)=>{var _product$photos$;return/*#__PURE__*/_jsxs(\"div\",{className:\"recommendation-card\",onClick:()=>handleProductClick(product.id),style:{cursor:\"pointer\"},children:[/*#__PURE__*/_jsx(\"img\",{src:`${config.apiUrl}/media/${product.photos&&(_product$photos$=product.photos[0])!==null&&_product$photos$!==void 0&&_product$photos$.path?product.photos[0].path:\"placeholder.jpg\"}`,alt:product.name,onError:e=>{e.target.src=\"https://placehold.co/250\";}}),/*#__PURE__*/_jsx(\"p\",{children:product.name})]},index);}):/*#__PURE__*/_jsx(\"div\",{className:\"loading-spinner\"})})]})]});};export default ClientDashboard;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}